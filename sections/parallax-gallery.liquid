{{ 'parallax-gallery.css' | asset_url | stylesheet_tag }}
{% liquid
  assign show_parallax_scroll = section.settings.show_parallax_scroll
  assign tag_html = 'div'
  if show_parallax_scroll
    assign tag_html = 'parallax-gallery'
  endif
%}
{%- render 'top-divider', show_top_divider: section.settings.show_top_divider, divider_top_width: section.settings.divider_top_width -%}
<div class="section-parallax-gallery section-padding section-bg" {% render 'section-attributes' %}>
  <div class="relative">
    <div class="parallax-gallery__inner flex justify-{{ section.settings.content_alignment }} z-[1] items-center container">
      <div class="parallax-gallery__content perpose__content text-{{ section.settings.content_alignment }} {{ section.settings.content_width }}">
        {%- if section.settings.subheading != blank -%}
          <p class="sub-heading">
            {{ section.settings.subheading }}
          </p>
        {%- endif -%}
        {%- if section.settings.heading != blank -%}
        <div class="{{ section.settings.heading_size }}">
          {{ section.settings.heading }}
        </div>
        {%- endif -%}
        {%- if section.settings.text != blank -%}
          <div class="image-with-text__text rte perpose__description">
            {{ section.settings.text }}
          </div>
        {%- endif -%}
        {%- if section.settings.button_label != blank -%}
          {%- render 'button',
              button_style: section.settings.button_type,
              button_text: section.settings.button_label,
              button_url:  section.settings.button_link,
              button_type: 'link',
              show_icon: section.settings.show_icon
          -%}
        {%- endif -%}
      </div>
    </div>
    <{{ tag_html }} class="parallax-gallery grid overflow-hidden {{ section.settings.section_width }} {% if section.settings.show_image_scroll %}parallax-gallery__image-scroll{% endif %}" style="--row-gap:{{ section.settings.row_gap }}vh;">
      <div class="parallax-gallery__images grid parallax-gallery__container" >
        {% for block in section.blocks %}
          {% if block.type == 'image' %}
          <div class="parallax-gallery__images-item grid parallax-gallery__item"   data-offset="{{ block.settings.offset_config }}" 
            style="--width-image:{{ block.settings.width_image }}px;" {{ block.shopify_attributes }}>
                {%- if block.settings.image != blank -%}
                  {% assign width = block.settings.width_image %}
                  {% assign image = block.settings.image %}
                  {% assign image_aspect_ratio = block.settings.image_size %}
                  {%- capture widths -%}{{ width }}, {{ width | times: 2 }}, {{ width | times: 3 }}{%- endcapture -%}
                  {%- capture sizes -%}(min-width: 768px) {{ width }}px, 50vw{%- endcapture -%}
                    {% render 'responsive-image', image: image, sizes: sizes, widths: widths, image_aspect_ratio: image_aspect_ratio %}
              {%- else -%}
                {% render 'placeholder-image', image_placeholder: 'image', image_aspect_ratio: image_aspect_ratio -%}
              {%- endif -%}
            </div>
          {% elsif block.type == 'video' %}
            {% liquid
              assign video_hosted = block.settings.video_hosted
              assign video_alt = block.settings.video_hosted.alt
              assign video_size = block.settings.video_size
              assign aspect_ratio_percent = 1 | divided_by: video_hosted.aspect_ratio | times: 100 | append: '%'
              assign widths ='200,300,400,500,600,700,800'
              assign sizes = block.settings.width_image | append: 'px'

              assign media_aspect_ratio = video_size
              case  media_aspect_ratio
                when 'adapt'
                  assign aspect_ratio = video_size
                when 'square'
                  assign aspect_ratio = 1
                when 'portrait'
                  assign aspect_ratio = 2.0 | divided_by: 2.5
                when 'landscape'
                  assign aspect_ratio = 4.0 | divided_by: 3.0
                when 'landscape-v2'
                  assign aspect_ratio = 5.0 | divided_by: 3.5
                when 'wide'
                  assign aspect_ratio = 16.0 | divided_by: 9.0
                else
                  assign aspect_ratio = video_size
              endcase
              if video_hosted != blank
                assign aspect_ratio_percent = 1 | divided_by: aspect_ratio | times: 100 | append: '%'
              else
                assign aspect_ratio_percent = 1 | divided_by: 1 | times: 100 | append: '%'
              endif
            %}
            <div class="parallax-gallery__images-item grid parallax-gallery__item"   data-offset="{{ block.settings.offset_config }}" 
            style="--width-image:{{ block.settings.width_image }}px;" {{ block.shopify_attributes }}>
                {%- if video_hosted != blank -%}
                  {% if video_size == 'adapt' %}
                    {%- assign aspect_ratio_percent = 1 | divided_by: video_hosted.aspect_ratio | times: 100 | append: '%'-%}
                  {% endif %}
                  <div class="gallery-grid__item-video" style="--aspect-ratio:{{ aspect_ratio_percent }}">
                  <viewport-media class="block w-full h-full absolute inset-0"> 
                    <template>
                      {{ video_hosted | video_tag: autoplay: true, loop: true, controls: false, muted: true, class:'pointer-events-none', preload: 'metadata', image_size:'300x', data-ignore-pause:"true", alt:video_alt }}
                    </template>  
                    {{- video_hosted.preview_image | image_url: width: video_hosted.preview_image.width | image_tag: loading: 'lazy', fetchpriority: 'auto', widths: widths , decoding:"async", class:'video-placeholder', alt:video_alt -}} 
                  </viewport-media>
                  </div>
                {%- else -%}
                  {%- assign video_hosted = "https://cdn.shopify.com/videos/c/o/v/00870923cec84b31bfc838bd80c6799d.mp4" -%}
                  <div class="gallery-grid__item-video" style="--aspect-ratio:{{ aspect_ratio_percent }}">
                    <video playsinline="playsinline" autoplay="autoplay" loop="loop" muted="muted" class="pointer-events-none" preload="metadata" data-ignore-pause="true" alt="" src="{{ video_hosted }}" ></video>
                  </div>
                {%- endif -%}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </{{ tag_html }}>
  </div>
</div>
{%- render 'bottom-divider', show_bottom_divider: section.settings.show_bottom_divider, divider_bottom_width: section.settings.divider_bottom_width -%}
{%- if show_parallax_scroll -%}
  <script src="{{ 'parallax-gallery.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

{% schema %}
{
  "name": "Parallax gallery",
  "tag": "section",
  "disabled_on": {
    "groups": ["header", "footer", "aside"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "select",
      "id": "content_alignment",
      "label": "Content alignment",
      "options": [
        {
          "value": "start",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "end",
          "label": "Right"
        }
      ],
      "default": "center"
    },
    {
      "type": "select",
      "id": "content_width",
      "label": "Content width",
      "options": [
        {
          "value": "max-w-3xl",
          "label": "Small"
        },
        {
          "value": "max-w-4xl",
          "label": "Normal"
        },
        {
          "value": "max-w-5xl",
          "label": "Large"
        },
        {
          "value": "w-full",
          "label": "Boxed"
        }
      ],
      "default": "max-w-4xl"
    },
    {
      "type": "text",
      "id": "subheading",
      "default": "Subheading",
      "label": "Subheading"
    },
    {
      "type": "text",
      "id": "heading",
      "default": "Parallax gallery heading",
      "label": "Heading"
    },
    {
      "type": "select",
      "id": "heading_size",
      "label": "Heading size",
      "options": [
        {
          "value": "hxl",
          "label": "Heading Xl"
        },
        {
          "value": "h0",
          "label": "Heading 0"
        },
        {
          "value": "h1",
          "label": "Heading 1"
        },
        {
          "value": "h2",
          "label": "Heading 2"
        },
        {
          "value": "h3",
          "label": "Heading 3"
        },
        {
          "value": "h4",
          "label": "Heading 4"
        },
        {
          "value": "h5",
          "label": "Heading 5"
        },
        {
          "value": "h6",
          "label": "Heading 6"
        }
      ],
      "default": "h1"
    },
    {
      "type": "richtext",
      "id": "text",
      "default": "<p>Pair text with an image to focus on your chosen product, collection, or blog post. Add details on availability, style, or even provide a review.</p>",
      "label": "Content"
    },
    {
      "type": "text",
      "id": "button_label",
      "default": "Button text",
      "label": "Button",
      "info": "Leave the label blank to hide the button."
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Button link"
    },
    {
      "type": "select",
      "id": "button_type",
      "label": "Button style",
      "options": [
        { "group": "Primary color","value": "primary","label": "Primary" },
        { "group": "Primary color","value": "outline","label": "Outline" },
        { "group": "Primary color","value": "underlined","label": "Underlined" },
        { "group": "White color","value": "primary-white","label": "Solid White" },
        { "group": "White color","value": "outline-white","label": "Outline White" },
        { "group": "White color","value": "underlined-white","label": "Underlined White" },
        { "group": "Accent color","value": "secondary","label": "Secondary" }
      ],
      "default": "primary"
    },
    {
      "type": "checkbox",
      "id": "show_icon",
      "label": "Show arrow icon",
      "default": false
    },
    {
      "type": "header",
      "content": "Section images "
    },
    {
      "type": "checkbox",
      "id": "show_parallax_scroll",
      "label": "Show parallax scroll",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_image_scroll",
      "label": "Images scroll now",
      "default": false
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Section images width",
      "options": [
        {
          "value": "container",
        "label": "Boxed"
        },
        {
          "value": "container-fluid",
          "label": "Wide"
        },
        {
          "value": "w-full",
          "label": "Full"
        }
      ],
      "default": "container"
    },
    {
      "type": "range",
      "id": "row_gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "vh",
      "label": "Row gap",
      "default": 20
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
        "type": "color",
        "id": "bg_color",
        "label": "Background"
    },
    {
        "type": "color",
        "id": "text_color",
        "label": "Text"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border"
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 36
    },
    {
      "type": "header",
      "content": "Section divider"
    },
    {
      "type": "checkbox",
      "id": "show_top_divider",
      "label": "Show top divider",
      "default": false
    },
    {
      "type": "select",
      "id": "divider_top_width",
      "label": "Divider top width",
      "options": [
        {
          "value": "container",
          "label": "Boxed"
        },
        {
          "value": "container-fluid",
          "label": "Wide"
        },
        {
          "value": "w-full",
          "label": "Full"
        }
      ],
      "default": "container"
    },
    {
      "type": "checkbox",
      "id": "show_bottom_divider",
      "label": "Show bottom divider",
      "default": false
    },
    {
      "type": "select",
      "id": "divider_bottom_width",
      "label": "Divider bottom width",
      "options": [
        {
          "value": "container",
          "label": "Boxed"
        },
        {
          "value": "container-fluid",
          "label": "Wide"
        },
        {
          "value": "w-full",
          "label": "Full"
        }
      ],
      "default": "container"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "range",
          "id": "width_image",
          "label": "Width image",
          "min": 100,
          "max": 400,
          "step": 4,
          "unit": "px",
          "default": 200
        },
        {
          "type": "select",
          "id": "image_size",
          "options": [
              { "value": "adapt","label": "Adapt to image" },
              { "value": "square","label": "Square(1:1)" },
              { "value": "portrait","label": "Portrait (2:3)" },
              { "value": "landscape","label": "Landscape (4:3)" },
              { "value": "landscape-v2","label": "Landscape (5:3.5)" },
              { "value": "wide","label": "Wide (16:9)" }
          ],
          "default": "adapt",
          "label": "Image size"
        },
        {
          "type": "paragraph",
          "content": "Parallax offset only works with Parallax animation type."
        },
        {
          "type": "number",
          "id": "offset_config",
          "label": "Parallax offset",
          "default": 50,
          "info": "Defines the parallax scrolling effect intensity. Positive values shift elements down; negative values shift them up."
        }
      ]
    },
    {
      "type": "video",
      "name": "Video",
      "settings": [
        {
          "type": "video",
          "id": "video_hosted",
          "label": "Video"
        },
        {
          "type": "range",
          "id": "width_image",
          "label": "Width image",
          "min": 100,
          "max": 400,
          "step": 4,
          "unit": "px",
          "default": 200
        },
        {
          "type": "select",
          "id": "video_size",
          "options": [
              { "value": "adapt","label": "Adapt to image" },
              { "value": "square","label": "Square(1:1)" },
              { "value": "portrait","label": "Portrait (2:3)" },
              { "value": "landscape","label": "Landscape (4:3)" },
              { "value": "landscape-v2","label": "Landscape (5:3.5)" },
              { "value": "wide","label": "Wide (16:9)" }
          ],
          "default": "adapt",
          "label": "Video size"
        },
        {
          "type": "paragraph",
          "content": "Parallax offset only works with Parallax animation type."
        },
        {
          "type": "number",
          "id": "offset_config",
          "label": "Parallax offset",
          "default": 50,
          "info": "Defines the parallax scrolling effect intensity. Positive values shift elements down; negative values shift them up."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Parallax gallery"
    }
  ]
}
{% endschema %}